<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stoc Farma Pro v6 - Final</title>
    <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #0f172a; --accent: #3b82f6; --success: #10b981; --danger: #ef4444; --bg: #f8fafc; --border: #e2e8f0; --st-expirat: #fee2e2; }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body { font-family: 'Inter', system-ui, sans-serif; margin: 0; background: var(--bg); color: var(--primary); }
        .top-bar { background: var(--primary); color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .main-container { padding: 12px; max-width: 1400px; margin: auto; }
        .controls { display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; }
        .btn { padding: 8px 14px; border-radius: 8px; font-weight: 600; font-size: 0.8rem; border: 1px solid var(--border); cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 6px; min-height: 42px; transition: 0.2s; }
        .btn-blue { background: var(--accent); color: white; border: none; }
        .btn-white { background: white; color: var(--primary); }
        .btn-danger { background: var(--danger); color: white; border: none; }
        .btn-delete { background: #fff1f2; color: #be123c; border: 1px solid #fda4af; padding: 8px 12px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .search-box { width: 100%; padding: 14px; border: 2px solid var(--border); border-radius: 12px; font-size: 1rem; margin-bottom: 10px; background: white; }
        .stats-bar { display: flex; justify-content: space-between; align-items: center; padding: 0 5px 10px; font-size: 0.85rem; color: #64748b; }
        .table-card { background: white; border-radius: 12px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .table-responsive { width: 100%; overflow-x: auto; max-height: 70vh; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; table-layout: fixed; }
        th { background: #f8fafc; padding: 14px; text-align: left; font-size: 0.75rem; text-transform: uppercase; color: #64748b; border-bottom: 2px solid var(--border); position: sticky; top: 0; z-index: 10; cursor: pointer; }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .input-inline { border: 1px solid transparent; background: transparent; padding: 8px; width: 100%; border-radius: 6px; font-size: 0.95rem; }
        .qty-box { width: 65px; border: 1.5px solid #e2e8f0; border-radius: 6px; padding: 8px; text-align: center; font-weight: 800; }
        .row-expirat { background-color: #fff1f2 !important; }
    </style>
</head>
<body>

<div class="top-bar">
    <h1 style="font-size: 0.9rem; margin:0; font-weight: 800;">STOC FARMA PRO</h1>
    <button class="btn btn-white" style="background:#4f46e5; color:white; border:none;" onclick="toggleModInventar()">MOD INVENTAR</button>
</div>

<div class="main-container">
    <div id="normalControls" class="controls">
        <button class="btn btn-blue" onclick="adaugaProdusNou()">+ PRODUS</button>
        <button class="btn btn-white" onclick="document.getElementById('excelInput').click()">ğŸ“¥ IMPORT</button>
        <button class="btn btn-white" onclick="creeazaBackup()">ğŸ’¾ BACKUP</button>
        <button class="btn btn-white" onclick="document.getElementById('restoreInput').click()">ğŸ”„ RESTORE</button>
        <button class="btn btn-white" style="border-color: #f59e0b; color: #d97706;" onclick="exportaIstoricAudit()">ğŸ“‹ JURNAL AUDIT</button>
        <button class="btn btn-white" style="color: #be123c;" onclick="golesteAudit()">ğŸ—‘ï¸ GOLIÈšI JURNAL</button>
        <input type="file" id="excelInput" style="display: none;" accept=".xlsx, .xls" onchange="importaExcelInteligent(event)" />
        <input type="file" id="restoreInput" style="display: none;" accept=".json" onchange="restaurareBackup(event)" />
    </div>

    <div id="inventarControls" class="controls" style="display: none;">
        <button class="btn btn-blue" onclick="exportaInventarExcel()">ğŸ“Š EXCEL RAFT</button>
        <button class="btn btn-white" onclick="finalizeazaInventar()">ğŸ“„ PDF</button>
        <button class="btn btn-danger" onclick="toggleModInventar()">ÃNCHIDE</button>
    </div>

    <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” CautÄƒ produs (Denumire)..." onkeyup="afiseaza()">

    <div class="stats-bar">
        <div>
            <span id="txtTotal">Total: 0</span> | 
            <span style="color:var(--danger); cursor:pointer" onclick="filtreazaSpeciale('expirate')">ğŸš© Vezi Expirate</span> |
            <span style="color:var(--accent); cursor:pointer" onclick="afiseaza()">ğŸ”„ Toate</span>
        </div>
    </div>

    <div class="table-card">
        <div class="table-responsive">
            <table>
                <thead><tr id="tableHeader"></tr></thead>
                <tbody id="listaCorp"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const db = new Dexie("FarmaPro_Final_V6");
    db.version(1).stores({ 
        produse: '++id, nume, cantitateInt, cantitateFrac, ambalaj, dataExpirare, ordine',
        istoric_verificari: '++id, nume, stocText, dataAudit'
    });

    let modInventar = false;
    let sensSortare = { nume: 1, dataExpirare: 1 };
    let inventarFaptic = {};

    async function afiseaza(dateSursa = null) {
        const query = document.getElementById('searchInput').value.toLowerCase().trim();
        const corp = document.getElementById('listaCorp');
        const header = document.getElementById('tableHeader');
        const azi = new Date();

        let date = dateSursa || await db.produse.orderBy('ordine').reverse().toArray();
        if (query && !dateSursa) date = date.filter(p => p.nume.toLowerCase().includes(query));

        document.getElementById('txtTotal').innerText = `Total: ${date.length} produse`;

        if (modInventar) {
            header.innerHTML = `<th>AcÈ›iuni</th><th onclick="sorteaza('nume')">Produs â†•ï¸</th><th>Emb.</th><th>NumÄƒrat (I/F)</th><th onclick="sorteaza('dataExpirare')">Expira â†•ï¸</th>`;
        } else {
            header.innerHTML = `<th style="width:80px">Audit</th><th onclick="sorteaza('nume')">Produs â†•ï¸</th><th>Emb.</th><th>Stoc (I/F)</th><th onclick="sorteaza('dataExpirare')">Expira â†•ï¸</th><th style="width:70px"></th>`;
        }

        let buffer = "";
        for (const p of date) {
            const dExp = parseDataRO(p.dataExpirare);
            const statusClass = (dExp && dExp < azi) ? 'row-expirat' : '';

            if (modInventar) {
                buffer += `<tr class="${statusClass}">
                    <td><button class="btn-white" onclick="duplica(${p.id})">+</button> <button class="btn-delete" style="padding:4px 8px" onclick="sterge(${p.id})">ğŸ—‘ï¸</button></td>
                    <td><input class="input-inline" style="font-weight:bold" value="${p.nume}" onchange="updateProd(${p.id}, 'nume', this.value)"></td>
                    <td align="center">${p.ambalaj}</td>
                    <td align="center">
                        <input type="number" class="qty-box" placeholder="I" onchange="updateFaptic(${p.id}, 'int', this.value)">
                        <input type="number" class="qty-box" style="border-color:var(--accent)" placeholder="F" onchange="updateFaptic(${p.id}, 'frac', this.value)">
                    </td>
                    <td><input class="input-inline" style="text-align:center" value="${p.dataExpirare}" placeholder="ZZ/LL/AA" oninput="formatareData(this)" onchange="updateProd(${p.id}, 'dataExpirare', this.value)"></td>
                </tr>`;
            } else {
                buffer += `<tr class="${statusClass}">
                    <td align="center"><button class="btn-white" style="font-size:1.3rem" onclick="verificaStoc(${p.id})">ğŸ‘ï¸</button></td>
                    <td><b>${p.nume}</b></td>
                    <td align="center">${p.ambalaj}</td>
                    <td align="center"><b>${p.cantitateInt}i</b> / <span style="color:var(--accent)">${p.cantitateFrac}f</span></td>
                    <td align="center">${p.dataExpirare || '-'}</td>
                    <td><button class="btn-delete" style="padding:4px 8px" onclick="sterge(${p.id})">ğŸ—‘ï¸</button></td>
                </tr>`;
            }
        }
        corp.innerHTML = buffer;
    }

    async function verificaStoc(id) {
        const p = await db.produse.get(id);
        const stocSist = (p.cantitateInt * p.ambalaj) + p.cantitateFrac;
        const faptic = prompt(`ğŸ“Š AUDIT: ${p.nume}\nSISTEM: ${stocSist} unitÄƒÈ›i\nRAFT (unitÄƒÈ›i):`, stocSist);
        if (faptic === null) return;
        const nF = parseInt(faptic) || 0;
        const dif = nF - stocSist;
        if (confirm(`DIFERENÈšÄ‚: ${dif > 0 ? '+' : ''}${dif}\nActualizÄƒm?`)) {
            await db.produse.update(id, { cantitateInt: Math.floor(nF/p.ambalaj), cantitateFrac: nF%p.ambalaj });
            await db.istoric_verificari.add({ nume: p.nume, stocText: `S:${stocSist}|R:${nF}|D:${dif}`, dataAudit: new Date().toLocaleString('ro-RO') });
            afiseaza();
        }
    }

    async function importaExcelInteligent(e) {
        const f = e.target.files[0];
        const r = new FileReader();
        r.onload = async (ev) => {
            try {
                const wb = XLSX.read(new Uint8Array(ev.target.result), {type:'array'});
                const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                if (!data.length) throw "FiÈ™ier gol";
                for(let row of data) {
                    const fK = (keys) => Object.keys(row).find(k => keys.some(key => k.toLowerCase().includes(key)));
                    await db.produse.add({
                        nume: (row[fK(['nume','prod','denu','articol'])] || "FÄƒrÄƒ nume").toString(),
                        cantitateInt: parseInt(row[fK(['stoc','buc','qty','intreg'])]) || 0,
                        cantitateFrac: parseInt(row[fK(['frac','tab','fiol'])]) || 0,
                        ambalaj: parseInt(row[fK(['amb','pack','impach'])]) || 10,
                        dataExpirare: (row[fK(['exp','data','valab','termen'])] || "").toString(),
                        ordine: Date.now()
                    });
                }
                afiseaza(); alert(`Importat cu succes!`);
            } catch (err) { alert("

